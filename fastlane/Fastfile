default_platform(:ios)

platform :ios do
  before_all do
    if ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"]
      app_store_connect_api_key(
        key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
        key_filepath: ENV["APP_STORE_CONNECT_API_KEY_KEY_FILEPATH"]
      )
    end
  end

  desc "Build the app for App Store submission"
  lane :build do
    increment_build_number_if_needed

    get_certificates(
      platform: "ios"
    )

    get_provisioning_profile(
      app_identifier: "com.sambender.Sweep",
      readonly: false
    )

    build_app(
      scheme: "Sweep",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "Sweep.ipa"
    )
  end

  desc "Upload to App Store Connect (TestFlight)"
  lane :beta do
    build
    upload_to_testflight(
      skip_waiting_for_build_processing: true
    )
  end

  desc "Upload to App Store for review"
  lane :release do
    build
    upload_to_app_store(
      skip_screenshots: false,
      skip_metadata: false,
      submit_for_review: false,
      automatic_release: false,
      precheck_include_in_app_purchases: false,
      force: true
    )
  end

  desc "Increment build number if current build exists on App Store Connect"
  private_lane :increment_build_number_if_needed do
    latest_build = latest_testflight_build_number(
      app_identifier: "com.sambender.Sweep"
    ) rescue 0

    current_build = get_build_number.to_i

    if current_build <= latest_build
      increment_build_number(
        build_number: latest_build + 1
      )
    end
  end

  desc "Run tests"
  lane :test do
    run_tests(
      scheme: "Sweep",
      device: "iPhone 16 Pro Max"
    )
  end

  desc "Take screenshots for App Store"
  lane :screenshots do
    capture_screenshots(
      scheme: "Sweep"
    )
  end
end
